version: 2.1

orbs:
   node: circleci/node@4.7
   docker: circleci/docker@2.0.0

jobs:
   build_ncc:
      executor:
         name: node/default
         tag: 16.13.0
      steps:
         - checkout
         - node/install-packages:
              pkg-manager: yarn
         - run: yarn build:ncc
         - run: node scripts/zip.cjs
         - store_artifacts:
            path: ~/project/dist
         - run: node dist/ncc/index.js
         - run: rm -rf node_modules
         - run: node dist/ncc/index.js
   build_pkg:
      executor:
         name: node/default
         tag: 16.13.0
      steps:
         - checkout
         - node/install-packages:
              pkg-manager: yarn
         - run: yarn build:tsc
         - run: yarn build:pkg
         - store_artifacts:
            path: ~/project/dist/pkg
         - run: ./dist/pkg/typecraft-linux
         - run: rm -rf node_modules
         - run: ./dist/pkg/typecraft-linux
   build_tsc:
      executor:
         name: node/default
         tag: 16.13.0
      steps:
         - checkout
         - node/install-packages:
              pkg-manager: yarn
         - run: yarn build:tsc
         - store_artifacts:
            path: ~/project/dist/pkg
   build_esbuild:
      executor:
         name: node/default
         tag: 16.13.0
      steps:
         - checkout
         - node/install-packages:
              pkg-manager: yarn
         - run: yarn build:esb
         - store_artifacts:
            path: ~/project/dist/esb

workflows:
   bleeding:
      jobs:
         - build_tsc
         - build_esbuild
         - build_ncc
         - build_pkg